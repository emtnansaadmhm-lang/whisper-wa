<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whisper-WA | التحليل</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-dark: #1f5f3b;
      --primary-mid: #3f9b5f;
      --primary-light: #5fbf7a;
      --accent-glow: #8fd9a8;

      --bg-dark: #0e1a12;

      --glass-bg: rgba(20, 40, 30, 0.65);
      --glass-border: rgba(95, 191, 122, 0.3);

      --text-white: #ffffff;
      --text-muted: #c2dec9;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-white);
      min-height: 100vh;

      background-image:
        linear-gradient(rgba(31, 95, 59, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(31, 95, 59, 0.1) 1px, transparent 1px);
      background-size: 40px 40px;

      direction: rtl;
      overflow-x: hidden;
    }

    .animated-bg-logo {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: -1;
      width: 650px;
      pointer-events: none;
      opacity: 0.18;
      animation: cyberGlowPulse 8s ease-in-out infinite alternate;
    }
    .animated-bg-logo img {
      width: 100%;
      height: auto;
      filter: drop-shadow(0 0 30px var(--primary-mid));
    }
    @keyframes cyberGlowPulse {
      0% {
        opacity: 0.12;
        transform: translate(-50%, -50%) scale(0.95);
        filter: drop-shadow(0 0 20px var(--primary-dark));
      }
      100% {
        opacity: 0.32;
        transform: translate(-50%, -50%) scale(1.05);
        filter: drop-shadow(0 0 70px var(--accent-glow)) brightness(1.2);
      }
    }

    .main-container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* ✅ مكان الهيدر الموحد */
    #header-placeholder{
      width: 100%;
    }

    /* Cards grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .panel {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(14px);
      border-radius: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      padding: 16px;
      overflow: hidden;
    }

    .panel-title{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .panel-title h4{
      font-size: 1rem;
      color: var(--primary-light);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .muted { color: var(--text-muted); font-size: 0.85rem; }

    /* Summary cards */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media(max-width: 980px){
      .stat-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media(max-width: 560px){
      .stat-grid { grid-template-columns: 1fr; }
    }

    .stat {
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .stat .label { color: var(--text-muted); font-size: 0.82rem; }
    .stat .value { font-size: 1.25rem; font-weight: 700; }
    .stat .sub { color: rgba(255,255,255,0.75); font-size: 0.82rem; }

    /* Lists */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 280px;
      overflow: auto;
      padding-left: 2px;
    }

    .item {
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .item .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--accent-glow);
      background: rgba(95,191,122,0.12);
      white-space: nowrap;
    }

    .danger {
      background: rgba(255, 77, 77, 0.12);
      color: #ffd0d0;
      border-color: rgba(255, 77, 77, 0.25);
    }

    .warn {
      background: rgba(255, 193, 7, 0.12);
      color: #ffe7a6;
      border-color: rgba(255, 193, 7, 0.25);
    }

    .ok {
      background: rgba(95,191,122,0.12);
      color: #d8ffe4;
      border-color: rgba(95,191,122,0.25);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.88);
      overflow-wrap: anywhere;
    }

    /* Column spans */
    .col-12{ grid-column: span 12; }
    .col-8 { grid-column: span 8; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    @media(max-width: 980px){
      .col-8, .col-6, .col-4 { grid-column: span 12; }
    }

    .top-note{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .loader {
      display: none;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .loader.show { display: inline-flex; }

    /* ✅ أدوات الصفحة بدل هيدر داخلي */
    .page-tools{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top: -6px;
    }
    .btn-secondary {
      background: rgba(95, 191, 122, 0.12);
      border: 1px solid rgba(95, 191, 122, 0.35);
      color: var(--accent-glow);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Tajawal';
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      transition: 0.25s;
      white-space: nowrap;
    }
    .btn-secondary:hover {
      background: rgba(63, 155, 95, 0.35);
      border-color: rgba(95, 191, 122, 0.6);
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <div class="animated-bg-logo">
    <img src="logo.png" alt="Background Logo">
  </div>

  <div class="main-container">

    <!-- ✅ الهيدر الموحد -->
    <div id="header-placeholder"></div>

    <!-- ✅ أدوات التحليل (بدل ما كانت داخل الهيدر القديم) -->
    <div class="page-tools">
      <div class="loader" id="loader">
        <i class="fa-solid fa-circle-notch fa-spin"></i>
        <span id="txt-loading">جاري تحميل التحليل...</span>
      </div>

      <a class="btn-secondary" id="btn-back" href="chat.html">
        <i class="fa-solid fa-arrow-right"></i> <span id="txt-back">رجوع للشات</span>
      </a>

      <button class="btn-secondary" id="btn-refresh" type="button">
        <i class="fa-solid fa-rotate"></i> <span id="txt-refresh">تحديث</span>
      </button>

      <span class="pill" id="casePill"><i class="fa-solid fa-briefcase"></i> <span id="txt-case">قضية رقم: #055xxx</span></span>
      <span class="pill" id="suspectPill"><i class="fa-solid fa-user-secret"></i> <span id="txt-suspect">المشتبه: 055xxxx</span></span>
    </div>

    <div class="grid">

      <!-- Summary -->
      <section class="panel col-12">
        <div class="panel-title">
          <h4><i class="fa-solid fa-chart-simple"></i> <span id="txt-summary-title">ملخص عام للمشتبه</span></h4>
          <div class="top-note">
            <span class="muted" id="txt-note">البيانات الآن ديمو — لاحقًا بتجي من الباك إند</span>
          </div>
        </div>

        <div class="stat-grid" id="summaryStats"></div>
      </section>

      <!-- Activity -->
      <section class="panel col-6">
        <div class="panel-title">
          <h4><i class="fa-solid fa-clock"></i> <span id="txt-activity-title">نمط النشاط</span></h4>
        </div>

        <div class="list" id="activityList"></div>
      </section>

      <!-- Flags -->
      <section class="panel col-6">
        <div class="panel-title">
          <h4><i class="fa-solid fa-triangle-exclamation"></i> <span id="txt-flags-title">مؤشرات مبدئية</span></h4>
        </div>

        <div class="list" id="flagsList"></div>
      </section>

      <!-- URLs -->
      <section class="panel col-6">
        <div class="panel-title">
          <h4><i class="fa-solid fa-link"></i> <span id="txt-urls-title">الروابط المستخرجة</span></h4>
          <span class="pill" id="urlsCountPill">0</span>
        </div>

        <div class="list" id="urlsList"></div>
      </section>

      <!-- Numbers -->
      <section class="panel col-6">
        <div class="panel-title">
          <h4><i class="fa-solid fa-hashtag"></i> <span id="txt-numbers-title">الأرقام المستخرجة</span></h4>
          <span class="pill" id="numbersCountPill">0</span>
        </div>

        <div class="list" id="numbersList"></div>
      </section>

      <!-- Keywords -->
      <section class="panel col-12">
        <div class="panel-title">
          <h4><i class="fa-solid fa-magnifying-glass"></i> <span id="txt-keywords-title">كلمات مهمة (Hits)</span></h4>
          <span class="muted" id="txt-keywords-note">قائمة كلمات ثابتة الآن — لاحقًا من الباك إند/الإعدادات</span>
        </div>

        <div class="list" id="keywordsList"></div>
      </section>

    </div>
  </div>

  <script>
    // ==========================================
    // ✅ 0) تحميل الهيدر الموحد + ربط زر اللغة
    // ==========================================
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-placeholder").innerHTML = html;

        // ✅ ربط زر اللغة الموجود داخل header.html
        const btnLang = document.getElementById("btnLang");
        if (btnLang) btnLang.addEventListener("click", toggleLanguage);

        // ✅ تحديث رابط الحساب لو تبين تمرير باراميتر
        // (اختياري) مثال:
        // const acc = document.querySelector('a[href="account.html"]');
        // if (acc) acc.href = `account.html?case=${encodeURIComponent(caseId)}&suspect=${encodeURIComponent(suspect)}`;
      })
      .catch(() => {
        // لو ما انوجد header.html لا توقف الصفحة
        document.getElementById("header-placeholder").innerHTML = "";
      });

    // ==========================================
    // ✅ 1) قراءة باراميترات الرابط (case / suspect)
    // ==========================================
    const params = new URLSearchParams(window.location.search);
    const caseId = params.get("case") || "055xxx";
    const suspect = params.get("suspect") || "055xxxx";

    document.getElementById("txt-case").textContent = `قضية رقم: #${caseId}`;
    document.getElementById("txt-suspect").textContent = `المشتبه: ${suspect}`;

    // ==========================================
    // ✅ 2) داتا ديمو (إلى أن يجي الباك إند)
    // ==========================================
    const demoAnalysis = {
      summary: {
        total_messages: 342,
        sent: 180,
        received: 162,
        first_contact: "2026-02-01 09:20",
        last_contact: "2026-02-12 23:10",
        urls_count: 12,
        numbers_count: 6,
        keyword_hits_total: 9
      },
      activity: [
        { label: "أكثر ساعة نشاط", value: "11:00 مساءً" },
        { label: "أكثر يوم نشاط", value: "2026-02-12" },
        { label: "مدة التواصل", value: "12 يوم" },
        { label: "نسبة مرسل/مستلم", value: "52% / 48%" }
      ],
      flags: [
        { level: "warn", title: "وجود روابط مختصرة", desc: "تم رصد روابط قصيرة (مثل bit.ly) تحتاج تحقق." },
        { level: "danger", title: "كلمات مرتبطة بالتحويل/التحقق", desc: "تم رصد كلمات مثل: OTP، تحويل، كود." },
        { level: "ok", title: "تسلسل زمني واضح", desc: "الرسائل مرتبة بزمنها بدون فجوات كبيرة في هذا الديمو." }
      ],
      urls: [
        { url: "https://bit.ly/3xxxx", count: 4 },
        { url: "https://t.me/example", count: 3 },
        { url: "https://example.com/login", count: 2 },
        { url: "https://maps.app.goo.gl/xxxxx", count: 1 }
      ],
      numbers: [
        { value: "0501234567", context: "رقم مذكور داخل رسالة", count: 2 },
        { value: "SA0000000000000000000000", context: "شكل IBAN (تجريبي)", count: 1 },
        { value: "123456", context: "كود/OTP محتمل", count: 3 }
      ],
      keywords: [
        { keyword: "OTP", hits: 3, examples: ["أرسل OTP بسرعة", "لا تعطي OTP لأحد"] },
        { keyword: "تحويل", hits: 2, examples: ["حول المبلغ", "تم التحويل"] },
        { keyword: "بنك", hits: 1, examples: ["من البنك اتصلوا"] },
        { keyword: "كود", hits: 3, examples: ["أرسل الكود", "الكود وصل"] }
      ]
    };

    // ==========================================
    // ✅ 3) Rendering helpers
    // ==========================================
    function setPill(el, text) { el.textContent = text; }

    function renderSummary(data) {
      const wrap = document.getElementById("summaryStats");
      wrap.innerHTML = "";

      const cards = [
        { label: "عدد الرسائل", value: data.total_messages, sub: `مرسل: ${data.sent} | مستلم: ${data.received}` },
        { label: "أول تواصل", value: data.first_contact.split(" ")[0], sub: data.first_contact },
        { label: "آخر تواصل", value: data.last_contact.split(" ")[0], sub: data.last_contact },
        { label: "Artifacts", value: `${data.urls_count} رابط`, sub: `${data.numbers_count} رقم | ${data.keyword_hits_total} Hits` }
      ];

      cards.forEach(c => {
        const div = document.createElement("div");
        div.className = "stat";
        div.innerHTML = `
          <div class="label">${c.label}</div>
          <div class="value">${c.value}</div>
          <div class="sub">${c.sub}</div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderSimpleList(listId, rows) {
      const wrap = document.getElementById(listId);
      wrap.innerHTML = "";
      rows.forEach(r => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="row">
            <span class="mono">${r.label}</span>
            <span class="pill ok">${r.value}</span>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderFlags(flags) {
      const wrap = document.getElementById("flagsList");
      wrap.innerHTML = "";
      flags.forEach(f => {
        const div = document.createElement("div");
        div.className = "item";
        const pillClass = f.level === "danger" ? "danger" : (f.level === "warn" ? "warn" : "ok");
        div.innerHTML = `
          <div class="row">
            <span class="mono"><b>${f.title}</b></span>
            <span class="pill ${pillClass}">${f.level === "danger" ? "مهم" : (f.level === "warn" ? "تنبيه" : "مقبول")}</span>
          </div>
          <div class="muted">${f.desc}</div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderUrls(urls) {
      const wrap = document.getElementById("urlsList");
      wrap.innerHTML = "";
      setPill(document.getElementById("urlsCountPill"), `${urls.length} روابط`);

      if (!urls.length) {
        wrap.innerHTML = `<div class="muted">لا توجد روابط.</div>`;
        return;
      }

      urls.forEach(u => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="row">
            <span class="mono">${u.url}</span>
            <span class="pill">${u.count} مرة</span>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderNumbers(nums) {
      const wrap = document.getElementById("numbersList");
      wrap.innerHTML = "";
      setPill(document.getElementById("numbersCountPill"), `${nums.length} أرقام`);

      if (!nums.length) {
        wrap.innerHTML = `<div class="muted">لا توجد أرقام.</div>`;
        return;
      }

      nums.forEach(n => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="row">
            <span class="mono">${n.value}</span>
            <span class="pill">${n.count} مرة</span>
          </div>
          <div class="muted">${n.context}</div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderKeywords(keys) {
      const wrap = document.getElementById("keywordsList");
      wrap.innerHTML = "";

      keys.forEach(k => {
        const div = document.createElement("div");
        div.className = "item";
        const examples = (k.examples || []).slice(0,3).map(x => `• ${x}`).join("<br>");
        div.innerHTML = `
          <div class="row">
            <span class="mono"><b>${k.keyword}</b></span>
            <span class="pill">${k.hits} Hits</span>
          </div>
          <div class="muted">${examples || "—"}</div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderAll(payload) {
      renderSummary(payload.summary);
      renderSimpleList("activityList", payload.activity);
      renderFlags(payload.flags);
      renderUrls(payload.urls);
      renderNumbers(payload.numbers);
      renderKeywords(payload.keywords);
    }

    // ==========================================
    // ✅ 4) تجهيز للباك اند لاحقًا (API)
    // ==========================================
    async function loadFromBackend() {
      const loader = document.getElementById("loader");
      loader.classList.add("show");

      try {
        const url = `/api/analysis?case=${encodeURIComponent(caseId)}&suspect=${encodeURIComponent(suspect)}`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });

        if (!res.ok) throw new Error("API not ready");
        const data = await res.json();

        renderAll(data);
        document.getElementById("txt-note").textContent = "تم تحميل البيانات من الباك إند ✅";
      } catch (e) {
        renderAll(demoAnalysis);
        document.getElementById("txt-note").textContent = "البيانات الآن ديمو — لاحقًا بتجي من الباك إند";
      } finally {
        loader.classList.remove("show");
      }
    }

    document.getElementById("btn-refresh").addEventListener("click", loadFromBackend);
    loadFromBackend();

    // ==========================================
    // ✅ 5) تبديل اللغة
    // ==========================================
    let currentLang = 'ar';

    function toggleLanguage() {
      const htmlTag = document.documentElement;

      if (currentLang === 'ar') {
        currentLang = 'en';
        htmlTag.setAttribute('lang', 'en');
        htmlTag.setAttribute('dir', 'ltr');

        document.title = "Whisper-WA | Analysis";
        document.getElementById("txt-case").textContent = `Case #: ${caseId}`;
        document.getElementById("txt-suspect").textContent = `Suspect: ${suspect}`;

        document.getElementById("txt-back").textContent = "Back to Chat";
        document.getElementById("txt-refresh").textContent = "Refresh";
        document.getElementById("txt-loading").textContent = "Loading analysis...";

        document.getElementById("txt-summary-title").textContent = "Suspect Overview";
        document.getElementById("txt-activity-title").textContent = "Activity Pattern";
        document.getElementById("txt-flags-title").textContent = "Initial Flags";
        document.getElementById("txt-urls-title").textContent = "Extracted URLs";
        document.getElementById("txt-numbers-title").textContent = "Extracted Numbers";
        document.getElementById("txt-keywords-title").textContent = "Important Keywords (Hits)";
        document.getElementById("txt-keywords-note").textContent = "Static list now — later from backend/settings";

        // ✅ زر الهيدر (AR/EN)
        const langText = document.getElementById("langText");
        if (langText) langText.textContent = "AR";

      } else {
        currentLang = 'ar';
        htmlTag.setAttribute('lang', 'ar');
        htmlTag.setAttribute('dir', 'rtl');

        document.title = "Whisper-WA | التحليل";
        document.getElementById("txt-case").textContent = `قضية رقم: #${caseId}`;
        document.getElementById("txt-suspect").textContent = `المشتبه: ${suspect}`;

        document.getElementById("txt-back").textContent = "رجوع للشات";
        document.getElementById("txt-refresh").textContent = "تحديث";
        document.getElementById("txt-loading").textContent = "جاري تحميل التحليل...";

        document.getElementById("txt-summary-title").textContent = "ملخص عام للمشتبه";
        document.getElementById("txt-activity-title").textContent = "نمط النشاط";
        document.getElementById("txt-flags-title").textContent = "مؤشرات مبدئية";
        document.getElementById("txt-urls-title").textContent = "الروابط المستخرجة";
        document.getElementById("txt-numbers-title").textContent = "الأرقام المستخرجة";
        document.getElementById("txt-keywords-title").textContent = "كلمات مهمة (Hits)";
        document.getElementById("txt-keywords-note").textContent = "قائمة كلمات ثابتة الآن — لاحقًا من الباك إند/الإعدادات";

        const langText = document.getElementById("langText");
        if (langText) langText.textContent = "EN";
      }
    }
  </script>
</body>
</html>
